<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
          rel="stylesheet">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,500,1,0"/>
    <script src="html5-qrcode.js" type="application/javascript"></script>

    <style>
        body {
     font-family: 'Inter', sans-serif;
 }
 video { border-radius: 30px; }
 #qr-shaded-region { border-radius: 30px; }
 .parent { position: relative; top: 0; left: 0; }
 .settings-icon-container {
     background-color: white;
     border-radius: 50%;
     width: 30px;
     height: 30px;
     display: flex;
     justify-content: center;
     align-items: center;
     position: fixed;
     top: 15px;
     right: 15px;
     z-index: 2;
 }
 .settings-icon { color: #939e4a; cursor: pointer; }
 #cameraSelector {
     display: none;
     position: fixed;
     top: 50px;
     right: 15px;
     background-color: rgba(255,255,255,0.9);
     border: 1px solid #ddd;
     border-radius: 5px;
     padding: 10px;
     z-index: 3;
     width: 300px;
     box-shadow: 0px 2px 4px rgba(0,0,0,0.2);
 }
 select { padding: 5px; width: 100%; }

 .camera-selector-title {
     margin-bottom: 10px;
     font-size: 16px;
     text-align: left;
 }

select {
    padding: 7px 10px;
    margin: 7px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    font-family: 'Inter', sans-serif;
    font-size: 16px;
    transition: all 0.3s ease;
}

select:hover {
    border-color: #888;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

select:focus {
    outline: none;
    border-color: #5b9dd9;
    box-shadow: 0 0 0 2px rgba(91, 157, 217, 0.5);
}

    </style>
</head>
<body>

<div class="parent">
    <div class="settings-icon-container">
        <span id="openSettings" class="material-symbols-outlined settings-icon">settings</span>
    </div>
    <div id="cameraSelector">
        <div class="camera-selector-title">Seleziona fotocamere</div>
        <select id="cameraList" onchange="changeCamera(this.value)"></select>
    </div>
    <div id="reader"></div>
</div>

<script>
    let html5QrCode;
    let isScannerRunning = false;

    function populateCameraList(cameras) {
        const cameraList = document.getElementById('cameraList');
        cameraList.innerHTML = '';
        cameras.forEach((camera, index) => {
            const option = document.createElement('option');
            option.value = camera.id;
            option.innerText = camera.label || `Camera ${index+1}`;
            cameraList.appendChild(option);
        });
    }

    async function startCamera(cameraId) {
        const config = { fps: 30, qrbox: { width: 200, height: 200 }, rememberLastUsedCamera: true };
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            console.log(`QR Code detected: ${decodedText}`);
        };
        if (isScannerRunning) {
            await html5QrCode.stop();
            isScannerRunning = false;
        }
        html5QrCode.start({ deviceId: { exact: cameraId } }, config, qrCodeSuccessCallback)
            .then(() => {
                isScannerRunning = true;
            })
            .catch(err => {
                console.error(`Error starting camera with ID ${cameraId}: ${err}`);
                isScannerRunning = false;
            });
    }

    function changeCamera(cameraId) {
        if (cameraId) {
            startCamera(cameraId);
        }
    }

    document.getElementById('openSettings').addEventListener('click', function(event) {
        event.stopPropagation();
        const cameraSelector = document.getElementById('cameraSelector');
        cameraSelector.style.display = cameraSelector.style.display === 'none' ? 'block' : 'none';
    });

    document.addEventListener('click', function() {
        const cameraSelector = document.getElementById('cameraSelector');
        if(cameraSelector.style.display === 'block') {
            cameraSelector.style.display = 'none';
        }
    });

    document.getElementById('cameraSelector').addEventListener('click', function(event) {
        event.stopPropagation();
    });

    window.onload = () => {
        html5QrCode = new Html5Qrcode("reader");
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                populateCameraList(devices);
                startCamera(devices[0].id);
            }
        }).catch(err => {
            console.error(`Errore nel recuperare le fotocamere: ${err}`);
        });
    };
</script>
</body>
</html>
