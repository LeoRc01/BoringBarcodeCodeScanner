<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,500,1,0"/>
    <script src="html5-qrcode.js" type="application/javascript"></script>

    <style>
        video { border-radius: 30px; }
        #qr-shaded-region { border-radius: 30px; }
        .parent { position: relative; top: 0; left: 0; }
        .settings-icon { color: green; cursor: pointer; z-index: 2; position: fixed; top: 15px; right: 15px; }
        #cameraSelector {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255,255,255,0.9);
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            z-index: 3;
            width: 300px;
        }
        select { padding: 5px; width: 100%; }
    </style>
</head>
<body>

<div class="parent">
    <span id="openSettings" class="material-symbols-outlined settings-icon">settings</span>
    <div id="cameraSelector">
        <select id="cameraList" onchange="changeCamera(this.value)"></select>

    </div>
    <div id="reader"></div>
</div>

<script>
    let html5QrCode;
    let isScannerRunning = false;

    function populateCameraList(cameras) {
        const cameraList = document.getElementById('cameraList');
        cameraList.innerHTML = '';
        cameras.forEach((camera, index) => {
            const option = document.createElement('option');
            option.value = camera.id;
            option.innerText = camera.label || `Camera ${index+1}`;
            cameraList.appendChild(option);
        });
    }

    async function startCamera(cameraId) {
        const config = { fps: 10, qrbox: { width: 250, height: 250 }, rememberLastUsedCamera: true };
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            console.log(`QR Code detected: ${decodedText}`);
        };
        if (isScannerRunning) {
            await html5QrCode.stop();
            isScannerRunning = false;
        }
        html5QrCode.start({ deviceId: { exact: cameraId } }, config, qrCodeSuccessCallback)
            .then(() => {
                isScannerRunning = true;
            })
            .catch(err => {
                console.error(`Error starting camera with ID ${cameraId}: ${err}`);
                isScannerRunning = false;
            });
    }

    function changeCamera(cameraId) {
        if (cameraId) {
            startCamera(cameraId);
        }
    }

    document.getElementById('openSettings').addEventListener('click', function(event) {
        event.stopPropagation();
        const cameraSelector = document.getElementById('cameraSelector');
        cameraSelector.style.display = cameraSelector.style.display === 'none' ? 'block' : 'none';
    });

    document.addEventListener('click', function() {
        const cameraSelector = document.getElementById('cameraSelector');
        if(cameraSelector.style.display === 'block') {
            cameraSelector.style.display = 'none';
        }
    });

    document.getElementById('cameraSelector').addEventListener('click', function(event) {
        event.stopPropagation();
    });

    window.onload = () => {
        html5QrCode = new Html5Qrcode("reader");
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                populateCameraList(devices);
                startCamera(devices[0].id);
            }
        }).catch(err => {
            console.error(`Errore nel recuperare le fotocamere: ${err}`);
        });
    };
</script>
</body>
</html>
